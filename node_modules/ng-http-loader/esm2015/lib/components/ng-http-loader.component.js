/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { EMPTY, merge, timer } from 'rxjs';
import { debounce, delayWhen } from 'rxjs/operators';
import { PendingInterceptorService } from '../services/pending-interceptor.service';
import { SpinnerVisibilityService } from '../services/spinner-visibility.service';
import { Spinkit } from '../spinkits';
export class NgHttpLoaderComponent {
    /**
     * @param {?} pendingInterceptorService
     * @param {?} spinnerVisibilityService
     */
    constructor(pendingInterceptorService, spinnerVisibilityService) {
        this.pendingInterceptorService = pendingInterceptorService;
        this.spinnerVisibilityService = spinnerVisibilityService;
        this.spinkit = Spinkit;
        this.spinner = Spinkit.skCubeGrid;
        this.filteredUrlPatterns = [];
        this.filteredMethods = [];
        this.filteredHeaders = [];
        this.debounceDelay = 0;
        this.minDuration = 0;
        this.entryComponent = null;
        this.subscriptions = merge(this.pendingInterceptorService.pendingRequestsStatus$.pipe(debounce(this.handleDebounceDelay.bind(this)), delayWhen(this.handleMinDuration.bind(this))), this.spinnerVisibilityService.visibilityObservable$)
            .subscribe(this.handleSpinnerVisibility().bind(this));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.nullifySpinnerIfEntryComponentIsDefined();
        if (!(this.filteredUrlPatterns instanceof Array)) {
            throw new TypeError('`filteredUrlPatterns` must be an array.');
        }
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(e => {
                this.pendingInterceptorService.filteredUrlPatterns.push(new RegExp(e));
            });
        }
        if (!(this.filteredMethods instanceof Array)) {
            throw new TypeError('`filteredMethods` must be an array.');
        }
        this.pendingInterceptorService.filteredMethods = this.filteredMethods;
        if (!(this.filteredHeaders instanceof Array)) {
            throw new TypeError('`filteredHeaders` must be an array.');
        }
        this.pendingInterceptorService.filteredHeaders = this.filteredHeaders;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
    /**
     * @return {?}
     */
    nullifySpinnerIfEntryComponentIsDefined() {
        if (null != this.entryComponent) {
            this.spinner = null;
        }
    }
    /**
     * @return {?}
     */
    handleSpinnerVisibility() {
        return v => this.isSpinnerVisible = v;
    }
    /**
     * @param {?} hasPendingRequests
     * @return {?}
     */
    handleDebounceDelay(hasPendingRequests) {
        if (hasPendingRequests && !!this.debounceDelay) {
            return timer(this.debounceDelay);
        }
        return EMPTY;
    }
    /**
     * @param {?} hasPendingRequests
     * @return {?}
     */
    handleMinDuration(hasPendingRequests) {
        if (hasPendingRequests || !this.minDuration) {
            this.startTime = Date.now();
            return timer(0);
        }
        /** @type {?} */
        const timerObservable = timer(this.minDuration - (Date.now() - this.startTime));
        this.startTime = null;
        return timerObservable;
    }
}
NgHttpLoaderComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-http-loader',
                template: `<div id="spinner" *ngIf="isSpinnerVisible">

    <ng-container *ngComponentOutlet="entryComponent"></ng-container>

    <sk-cube-grid
        *ngIf="spinner === spinkit.skCubeGrid"
        [backgroundColor]="backgroundColor">
    </sk-cube-grid>

    <sk-chasing-dots
        *ngIf="spinner === spinkit.skChasingDots"
        [backgroundColor]="backgroundColor">
    </sk-chasing-dots>

    <sk-double-bounce
        *ngIf="spinner === spinkit.skDoubleBounce"
        [backgroundColor]="backgroundColor">
    </sk-double-bounce>

    <sk-rotating-plane
        *ngIf="spinner === spinkit.skRotatingPlane"
        [backgroundColor]="backgroundColor">
    </sk-rotating-plane>

    <sk-spinner-pulse
        *ngIf="spinner === spinkit.skSpinnerPulse"
        [backgroundColor]="backgroundColor">
    </sk-spinner-pulse>

    <sk-three-bounce
        *ngIf="spinner === spinkit.skThreeBounce"
        [backgroundColor]="backgroundColor">
    </sk-three-bounce>

    <sk-wandering-cubes
        *ngIf="spinner === spinkit.skWanderingCubes"
        [backgroundColor]="backgroundColor">
    </sk-wandering-cubes>

    <sk-wave
        *ngIf="spinner === spinkit.skWave"
        [backgroundColor]="backgroundColor">
    </sk-wave>

</div>

`,
                styles: [`#spinner{top:0;left:0;height:100%;width:100%;position:fixed;z-index:9999;opacity:.7;background-color:#f1f1f1;display:flex;align-items:center;justify-content:center}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}`]
            },] },
];
/** @nocollapse */
NgHttpLoaderComponent.ctorParameters = () => [
    { type: PendingInterceptorService },
    { type: SpinnerVisibilityService }
];
NgHttpLoaderComponent.propDecorators = {
    backgroundColor: [{ type: Input }],
    spinner: [{ type: Input }],
    filteredUrlPatterns: [{ type: Input }],
    filteredMethods: [{ type: Input }],
    filteredHeaders: [{ type: Input }],
    debounceDelay: [{ type: Input }],
    minDuration: [{ type: Input }],
    entryComponent: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    NgHttpLoaderComponent.prototype.isSpinnerVisible;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinkit;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.subscriptions;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.startTime;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.backgroundColor;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinner;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredUrlPatterns;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredMethods;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredHeaders;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.debounceDelay;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.minDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.entryComponent;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.pendingInterceptorService;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinnerVisibilityService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctaHR0cC1sb2FkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctaHR0cC1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZy1odHRwLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBU0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUE0QixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckUsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUNwRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNsRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBcUR0QyxNQUFNOzs7OztJQXVCRixZQUFvQix5QkFBb0QsRUFBVSx3QkFBa0Q7UUFBaEgsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUFVLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7dUJBckJuSCxPQUFPO3VCQU9QLE9BQU8sQ0FBQyxVQUFVO21DQUVJLEVBQUU7K0JBRU4sRUFBRTsrQkFFRixFQUFFOzZCQUVkLENBQUM7MkJBRUgsQ0FBQzs4QkFFTyxJQUFJO1FBRzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUN0QixJQUFJLENBQUMseUJBQXlCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUN0RCxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUM3QyxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUMvQyxFQUNELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxxQkFBcUIsQ0FDdEQ7YUFDSSxTQUFTLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDN0Q7Ozs7SUFFRCxRQUFRO1FBQ0osSUFBSSxDQUFDLHVDQUF1QyxFQUFFLENBQUM7UUFFL0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1NBQ2xFO1FBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxRSxDQUFDLENBQUM7U0FDTjtRQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxNQUFNLElBQUksU0FBUyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7U0FDOUQ7UUFDRCxJQUFJLENBQUMseUJBQXlCLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7UUFFdEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sSUFBSSxTQUFTLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUM5RDtRQUNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztLQUN6RTs7OztJQUVELFdBQVc7UUFDUCxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO0tBQ3BDOzs7O0lBRU8sdUNBQXVDO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUM5QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztTQUN2Qjs7Ozs7SUFHRyx1QkFBdUI7UUFDM0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBQzs7Ozs7O0lBR2xDLG1CQUFtQixDQUFDLGtCQUEyQjtRQUNuRCxFQUFFLENBQUMsQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDN0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDcEM7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDOzs7Ozs7SUFHVCxpQkFBaUIsQ0FBQyxrQkFBMkI7UUFDakQsRUFBRSxDQUFDLENBQUMsa0JBQWtCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUU1QixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ25COztRQUVELE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2hGLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBRXRCLE1BQU0sQ0FBQyxlQUFlLENBQUM7Ozs7WUE3STlCLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZ0JBQWdCO2dCQUMxQixRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Q0E4Q2I7Z0JBQ0csTUFBTSxFQUFFLENBQUMsNk9BQTZPLENBQUM7YUFDMVA7Ozs7WUF0RFEseUJBQXlCO1lBQ3pCLHdCQUF3Qjs7OzhCQTRENUIsS0FBSztzQkFFTCxLQUFLO2tDQUVMLEtBQUs7OEJBRUwsS0FBSzs4QkFFTCxLQUFLOzRCQUVMLEtBQUs7MEJBRUwsS0FBSzs2QkFFTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTXG4gKiBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1JcbiAqIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUlxuICogSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU5cbiAqIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEVNUFRZLCBtZXJnZSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCB0aW1lciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2UsIGRlbGF5V2hlbiB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9wZW5kaW5nLWludGVyY2VwdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3Bpbm5lci12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgU3BpbmtpdCB9IGZyb20gJy4uL3NwaW5raXRzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICduZy1odHRwLWxvYWRlcicsXG4gICAgdGVtcGxhdGU6IGA8ZGl2IGlkPVwic3Bpbm5lclwiICpuZ0lmPVwiaXNTcGlubmVyVmlzaWJsZVwiPlxuXG4gICAgPG5nLWNvbnRhaW5lciAqbmdDb21wb25lbnRPdXRsZXQ9XCJlbnRyeUNvbXBvbmVudFwiPjwvbmctY29udGFpbmVyPlxuXG4gICAgPHNrLWN1YmUtZ3JpZFxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tDdWJlR3JpZFwiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay1jdWJlLWdyaWQ+XG5cbiAgICA8c2stY2hhc2luZy1kb3RzXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za0NoYXNpbmdEb3RzXCJcbiAgICAgICAgW2JhY2tncm91bmRDb2xvcl09XCJiYWNrZ3JvdW5kQ29sb3JcIj5cbiAgICA8L3NrLWNoYXNpbmctZG90cz5cblxuICAgIDxzay1kb3VibGUtYm91bmNlXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za0RvdWJsZUJvdW5jZVwiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay1kb3VibGUtYm91bmNlPlxuXG4gICAgPHNrLXJvdGF0aW5nLXBsYW5lXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za1JvdGF0aW5nUGxhbmVcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stcm90YXRpbmctcGxhbmU+XG5cbiAgICA8c2stc3Bpbm5lci1wdWxzZVxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tTcGlubmVyUHVsc2VcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stc3Bpbm5lci1wdWxzZT5cblxuICAgIDxzay10aHJlZS1ib3VuY2VcbiAgICAgICAgKm5nSWY9XCJzcGlubmVyID09PSBzcGlua2l0LnNrVGhyZWVCb3VuY2VcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stdGhyZWUtYm91bmNlPlxuXG4gICAgPHNrLXdhbmRlcmluZy1jdWJlc1xuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tXYW5kZXJpbmdDdWJlc1wiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay13YW5kZXJpbmctY3ViZXM+XG5cbiAgICA8c2std2F2ZVxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tXYXZlXCJcbiAgICAgICAgW2JhY2tncm91bmRDb2xvcl09XCJiYWNrZ3JvdW5kQ29sb3JcIj5cbiAgICA8L3NrLXdhdmU+XG5cbjwvZGl2PlxuXG5gLFxuICAgIHN0eWxlczogW2Ajc3Bpbm5lcnt0b3A6MDtsZWZ0OjA7aGVpZ2h0OjEwMCU7d2lkdGg6MTAwJTtwb3NpdGlvbjpmaXhlZDt6LWluZGV4Ojk5OTk7b3BhY2l0eTouNztiYWNrZ3JvdW5kLWNvbG9yOiNmMWYxZjE7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyfTo6bmctZGVlcCAuY29sb3JlZC1wYXJlbnQsOjpuZy1kZWVwIC5jb2xvcmVkPmRpdntiYWNrZ3JvdW5kLWNvbG9yOiMzMzN9YF1cbn0pXG5leHBvcnQgY2xhc3MgTmdIdHRwTG9hZGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xuICAgIHB1YmxpYyBpc1NwaW5uZXJWaXNpYmxlOiBib29sZWFuO1xuICAgIHB1YmxpYyBzcGlua2l0ID0gU3BpbmtpdDtcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIHN0YXJ0VGltZTogbnVtYmVyO1xuXG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgc3Bpbm5lciA9IFNwaW5raXQuc2tDdWJlR3JpZDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBmaWx0ZXJlZFVybFBhdHRlcm5zOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGZpbHRlcmVkTWV0aG9kczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBmaWx0ZXJlZEhlYWRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZGVib3VuY2VEZWxheSA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgbWluRHVyYXRpb24gPSAwO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGVudHJ5Q29tcG9uZW50OiBhbnkgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlOiBQZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlLCBwcml2YXRlIHNwaW5uZXJWaXNpYmlsaXR5U2VydmljZTogU3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG1lcmdlKFxuICAgICAgICAgICAgdGhpcy5wZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyQucGlwZShcbiAgICAgICAgICAgICAgICBkZWJvdW5jZSh0aGlzLmhhbmRsZURlYm91bmNlRGVsYXkuYmluZCh0aGlzKSksXG4gICAgICAgICAgICAgICAgZGVsYXlXaGVuKHRoaXMuaGFuZGxlTWluRHVyYXRpb24uYmluZCh0aGlzKSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB0aGlzLnNwaW5uZXJWaXNpYmlsaXR5U2VydmljZS52aXNpYmlsaXR5T2JzZXJ2YWJsZSQsXG4gICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUodGhpcy5oYW5kbGVTcGlubmVyVmlzaWJpbGl0eSgpLmJpbmQodGhpcykpO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLm51bGxpZnlTcGlubmVySWZFbnRyeUNvbXBvbmVudElzRGVmaW5lZCgpO1xuXG4gICAgICAgIGlmICghKHRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYGZpbHRlcmVkVXJsUGF0dGVybnNgIG11c3QgYmUgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoISF0aGlzLmZpbHRlcmVkVXJsUGF0dGVybnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlcmVkVXJsUGF0dGVybnMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRVcmxQYXR0ZXJucy5wdXNoKG5ldyBSZWdFeHAoZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoISh0aGlzLmZpbHRlcmVkTWV0aG9kcyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYGZpbHRlcmVkTWV0aG9kc2AgbXVzdCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRNZXRob2RzID0gdGhpcy5maWx0ZXJlZE1ldGhvZHM7XG5cbiAgICAgICAgaWYgKCEodGhpcy5maWx0ZXJlZEhlYWRlcnMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2BmaWx0ZXJlZEhlYWRlcnNgIG11c3QgYmUgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlLmZpbHRlcmVkSGVhZGVycyA9IHRoaXMuZmlsdGVyZWRIZWFkZXJzO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG51bGxpZnlTcGlubmVySWZFbnRyeUNvbXBvbmVudElzRGVmaW5lZCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKG51bGwgIT0gdGhpcy5lbnRyeUNvbXBvbmVudCkge1xuICAgICAgICAgICAgdGhpcy5zcGlubmVyID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlU3Bpbm5lclZpc2liaWxpdHkoKTogKHY6IGJvb2xlYW4pID0+IHZvaWQge1xuICAgICAgICByZXR1cm4gdiA9PiB0aGlzLmlzU3Bpbm5lclZpc2libGUgPSB2O1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRGVib3VuY2VEZWxheShoYXNQZW5kaW5nUmVxdWVzdHM6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPG51bWJlciB8IG5ldmVyPiB7XG4gICAgICAgIGlmIChoYXNQZW5kaW5nUmVxdWVzdHMgJiYgISF0aGlzLmRlYm91bmNlRGVsYXkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aW1lcih0aGlzLmRlYm91bmNlRGVsYXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlTWluRHVyYXRpb24oaGFzUGVuZGluZ1JlcXVlc3RzOiBib29sZWFuKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgaWYgKGhhc1BlbmRpbmdSZXF1ZXN0cyB8fCAhdGhpcy5taW5EdXJhdGlvbikge1xuICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgICAgICByZXR1cm4gdGltZXIoMCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0aW1lck9ic2VydmFibGUgPSB0aW1lcih0aGlzLm1pbkR1cmF0aW9uIC0gKERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSkpO1xuICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG51bGw7XG5cbiAgICAgICAgcmV0dXJuIHRpbWVyT2JzZXJ2YWJsZTtcbiAgICB9XG59XG4iXX0=